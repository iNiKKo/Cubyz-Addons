<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Addon Info</title>
  <link rel="stylesheet" href="../../style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
</head>
<body>
  <header class="site-header">
    <div class="header-container">
      <h1 class="site-title bbh-sans-hegarty-regular">
        <a href="../../index.html" style="text-decoration: none; color: inherit;">
          <span class="cubyz">CubyzHub</span>
        </a>
      </h1>
    </div>
  </header>

  <div class="addon-detail-wrapper">
    <main class="addon-detail-main">

      <!-- Addon Header -->
      <div class="addon-card-header" id="addon-header">
        <img id="addon-icon" class="addon-header-image" alt="Addon Icon" />
        <div class="addon-header-content">
          <h2 id="addon-title"></h2>
          <p id="addon-shortdesc"></p>
          <a id="addon-download" class="download-btn" download>⬇ Download</a>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tab-menu">
        <button id="description-tab" class="active">Description</button>
        <button id="versions-tab">Versions</button>
      </div>

      <!-- Description Section -->
      <section id="description-section" class="addon-description">
        <img id="addon-banner" class="banner-img" alt="Addon Banner" />
        <div id="addon-longdesc"></div>
        <h3 id="screenshots-header" style="margin-top:20px;display:none;">Screenshots</h3>
        <div class="screenshot-grid" id="addon-screenshots"></div>
      </section>

      <!-- Versions Section -->
      <section id="versions-section" class="addon-description" style="display:none;">
        <h3>Addon Versions</h3>
        <ul class="addon-versions-list" id="version-list"></ul>
      </section>

    </main>

    <!-- Sidebar -->
    <aside class="addon-sidebar">
      <div class="sidebar-card">
        <h4>Compatibility</h4>
        <p><strong>Cubyz Version:</strong> <span id="addon-cubyzver"></span></p>
      </div>

      <div class="sidebar-card">
        <h4>File Information</h4>
        <p><strong>Addon Version:</strong> <span id="addon-version"></span></p>
        <p><strong>Last Updated:</strong> <span id="addon-updated"></span></p>
      </div>

      <div class="sidebar-card">
        <h4>Author</h4>
        <p><strong id="addon-author"></strong></p>
      </div>
    </aside>
  </div>

  <!-- Lightbox for screenshots -->
  <div id="lightbox" class="lightbox">
    <img src="" alt="Zoomed screenshot">
  </div>

  <!-- Inline Markdown Parser (tiny version of marked.js) -->
  <script>
    function parseMarkdown(md) {
      return md
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/gim, '<b>$1</b>')
        .replace(/\*(.*?)\*/gim, '<i>$1</i>')
        .replace(/`(.*?)`/gim, '<code>$1</code>')
        .replace(/\n$/gim, '<br />')
        .replace(/\n\n/gim, '<br><br>')
        .replace(/^- (.*$)/gim, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/gim, '<ul>$1</ul>');
    }
  </script>

  <!-- Page Script -->
  <script>
    async function loadAddonInfo() {
      try {
        const urlParts = window.location.pathname.split('/');
        const addonId = urlParts[urlParts.length - 1].replace('-info.html', '');
        const res = await fetch('../../addons.json');
        const addons = await res.json();
        const addon = addons.find(a => a.id === addonId);
        if (!addon) throw new Error('Addon not found');

        // Header info
        document.title = addon.name;
        document.getElementById('addon-title').textContent = addon.name;
        document.getElementById('addon-shortdesc').textContent = addon.description;
        document.getElementById('addon-icon').src = '../../' + addon.icon;
        document.getElementById('addon-download').href = '../../' + addon.download;

        // Banner & long description
        document.getElementById('addon-banner').src = '../../' + addon.banner;
        const longDesc = addon.longDescription || addon.description || '';
        document.getElementById('addon-longdesc').innerHTML = parseMarkdown(longDesc);

        // Sidebar
        document.getElementById('addon-author').textContent = addon.author || 'Unknown';
        document.getElementById('addon-version').textContent = addon.version || '—';
        document.getElementById('addon-updated').textContent = addon.updated || '—';
        document.getElementById('addon-cubyzver').textContent = addon.cubyzVersion || '—';

        // Screenshots
        const ssContainer = document.getElementById('addon-screenshots');
        if (addon.screenshots && addon.screenshots.length > 0) {
          document.getElementById('screenshots-header').style.display = 'block';
          addon.screenshots.forEach(src => {
            const img = document.createElement('img');
            img.src = '../../' + src;
            img.alt = 'Screenshot';
            ssContainer.appendChild(img);
            img.addEventListener('click', () => {
              lightboxImg.src = img.src;
              lightbox.style.display = 'flex';
            });
          });
        }

        // Versions list (newest first)
        const versionList = document.getElementById('version-list');
        if (addon.patchNotes && addon.patchNotes.length > 0) {
          addon.patchNotes
            .slice()
            .reverse()
            .forEach(v => {
              const li = document.createElement('li');
              li.innerHTML = `
                <div class="version-info">
                  <span><strong>${v.version}</strong> ${v.notes}</span>
                  <a href="../../${addon.download.replace(addon.version, v.version)}" class="version-download-btn" download>⬇ Download</a>
                </div>`;
              versionList.appendChild(li);
            });
        }
      } catch (err) {
        console.error('Error loading addon info:', err);
      }
    }

    // Tab control
    const descriptionTab = document.getElementById('description-tab');
    const versionsTab = document.getElementById('versions-tab');
    const descSection = document.getElementById('description-section');
    const verSection = document.getElementById('versions-section');

    descriptionTab.addEventListener('click', () => {
      descriptionTab.classList.add('active');
      versionsTab.classList.remove('active');
      descSection.style.display = 'block';
      verSection.style.display = 'none';
    });

    versionsTab.addEventListener('click', () => {
      versionsTab.classList.add('active');
      descriptionTab.classList.remove('active');
      descSection.style.display = 'none';
      verSection.style.display = 'block';
    });

    // Lightbox
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = lightbox.querySelector('img');
    lightbox.addEventListener('click', () => {
      lightbox.style.display = 'none';
      lightboxImg.src = '';
    });

    loadAddonInfo();
  </script>
</body>
</html>
